<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Tarefas com Mapa Mental Interativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/leader-line-new@1.1.9/leader-line.min.js"></script>
    <script src="https://unpkg.com/draggabilly@3/dist/draggabilly.pkgd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos CSS permanecem os mesmos */
        .node {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .node:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .node.selected {
            border: 2px solid #3b82f6;
        }
        .node.completed {
            opacity: 0.7;
            background-color: #f0fdf4;
        }
        .node.completed .task-time {
            text-decoration: line-through;
            color: #10b981;
        }
        .node.completed .text-gray-800 {
            text-decoration: line-through;
            color: #10b981;
        }
        .connection-handle {
            width: 16px;
            height: 16px;
            background-color: #3b82f6;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .node:hover .connection-handle {
            opacity: 1;
        }
        .day-checkbox:checked + label {
            background-color: #3b82f6;
            color: white;
        }
        .mindmap-container {
            overflow: hidden;
            position: relative;
            background-color: #f8fafc;
            background-image: 
                linear-gradient(#e2e8f0 1px, transparent 1px),
                linear-gradient(90deg, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .line-animation {
            transition: all 0.3s ease;
        }
        .task-time {
            font-family: monospace;
            font-weight: bold;
        }
        /* Z-index para garantir que a linha fique visível */
        .leader-line {
            z-index: 1;
        }
        @media (max-width: 768px) {
            .node {
                width: 120px;
                height: 120px;
                font-size: 0.9rem;
            }
            .task-time {
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-6">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Gerenciador de Tarefas com Mapa Mental</h1>
            <p class="text-gray-600">Visualize e organize suas tarefas com conexões interativas</p>
        </header>

        <div class="flex flex-col lg:flex-row gap-6">
            <div class="w-full lg:w-1/4 bg-white rounded-lg shadow-md p-6 h-fit">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Controles de Tarefas</h2>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nome da Tarefa</label>
                    <input type="text" id="taskName" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Digite o nome da tarefa">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Horário Agendado</label>
                    <input type="time" id="taskTime" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Repetição</label>
                    
                    <div class="space-y-2">
                        <div class="flex items-center">
                            <input type="radio" id="noRepeat" name="repeatOption" value="none" checked class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="noRepeat" class="ml-2 block text-sm text-gray-700">Não repetir</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="radio" id="specificDay" name="repeatOption" value="specific" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="specificDay" class="ml-2 block text-sm text-gray-700">Dia(s) específico(s)</label>
                        </div>
                        
                        <div class="flex items-center">
                            <input type="radio" id="everyDayExcept" name="repeatOption" value="except" class="h-4 w-4 text-blue-600 focus:ring-blue-500">
                            <label for="everyDayExcept" class="ml-2 block text-sm text-gray-700">Todos os dias exceto</label>
                        </div>
                    </div>
                    
                    <div id="daySelection" class="mt-4 hidden">
                         <div class="grid grid-cols-3 gap-2">
                            <div><input type="checkbox" id="monday" class="day-checkbox hidden" value="Monday"><label for="monday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Seg</label></div>
                            <div><input type="checkbox" id="tuesday" class="day-checkbox hidden" value="Tuesday"><label for="tuesday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Ter</label></div>
                            <div><input type="checkbox" id="wednesday" class="day-checkbox hidden" value="Wednesday"><label for="wednesday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Qua</label></div>
                            <div><input type="checkbox" id="thursday" class="day-checkbox hidden" value="Thursday"><label for="thursday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Qui</label></div>
                            <div><input type="checkbox" id="friday" class="day-checkbox hidden" value="Friday"><label for="friday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Sex</label></div>
                            <div><input type="checkbox" id="saturday" class="day-checkbox hidden" value="Saturday"><label for="saturday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Sáb</label></div>
                            <div><input type="checkbox" id="sunday" class="day-checkbox hidden" value="Sunday"><label for="sunday" class="block text-center py-2 px-3 border border-gray-300 rounded-md cursor-pointer text-sm">Dom</label></div>
                        </div>
                    </div>
                </div>
                
                <div class="flex space-x-3">
                    <button id="addTask" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Add Tarefa
                    </button>
                    <button id="clearAll" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-md transition flex items-center justify-center">
                        <i class="fas fa-trash-alt mr-2"></i> Limpar Tudo
                    </button>
                </div>
                
                <div class="mt-6 pt-4 border-t border-gray-200">
                    <h3 class="text-sm font-medium text-gray-700 mb-2">Instruções</h3>
                    <ul class="text-xs text-gray-600 space-y-1">
                        <li class="flex items-start"><i class="fas fa-circle text-blue-500 mt-1 mr-2 text-xs"></i><span>Arraste tarefas para reorganizá-las.</span></li>
                        <li class="flex items-start"><i class="fas fa-circle text-blue-500 mt-1 mr-2 text-xs"></i><span>Clique e arraste de um ponto azul a outro para criar links.</span></li>
                        <li class="flex items-start"><i class="fas fa-circle text-blue-500 mt-1 mr-2 text-xs"></i><span>Clique no 'X' para remover uma conexão.</span></li>
                        <li class="flex items-start"><i class="fas fa-circle text-blue-500 mt-1 mr-2 text-xs"></i><span>Marque tarefas como concluídas.</span></li>
                    </ul>
                </div>
            </div>
            
            <div class="w-full lg:w-3/4">
                <div class="bg-white rounded-lg shadow-md overflow-hidden mb-4">
                    <div class="mindmap-container" id="mindmap" style="height: 600px;"></div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-4">
                    <h3 class="font-medium text-gray-800 mb-2">Conexões de Tarefas</h3>
                    <div id="connectionsList" class="text-sm text-gray-600">
                        <p class="text-gray-400 italic">Nenhuma conexão ainda. Crie algumas arrastando entre os pontos de conexão.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos do DOM
        const mindmap = document.getElementById('mindmap');
        const addTaskBtn = document.getElementById('addTask');
        const clearAllBtn = document.getElementById('clearAll');
        const taskNameInput = document.getElementById('taskName');
        const taskTimeInput = document.getElementById('taskTime');
        const repeatOptions = document.querySelectorAll('input[name="repeatOption"]');
        const daySelection = document.getElementById('daySelection');
        const dayCheckboxes = document.querySelectorAll('.day-checkbox');
        const connectionsList = document.getElementById('connectionsList');

        // Estado da aplicação
        let tasks = {}; // Usando objeto para acesso rápido por ID
        let connections = [];
        let draggies = []; // Armazenar instâncias do Draggabilly

        // ----- INÍCIO DA LÓGICA DE CONEXÃO REFEITA -----
        let isConnecting = false;
        let startNode = null;
        let tempLine = null;

        mindmap.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('connection-handle')) {
                e.stopPropagation();
                isConnecting = true;
                startNode = e.target.closest('.node');
                
                // Cria uma linha temporária que segue o mouse
                tempLine = new LeaderLine(
                    startNode,
                    LeaderLine.pointAnchor(e.target.closest('.mindmap-container'), { x: e.clientX, y: e.clientY }), {
                        color: 'rgba(59, 130, 246, 0.5)',
                        size: 3,
                        dash: { animation: true }
                    }
                );
            }
        });

        mindmap.addEventListener('mousemove', (e) => {
            if (isConnecting && tempLine) {
                // Atualiza a posição da linha temporária
                tempLine.position();
                tempLine.end = LeaderLine.pointAnchor(e.target.closest('.mindmap-container'), { x: e.clientX, y: e.clientY });
            }
        });

        mindmap.addEventListener('mouseup', (e) => {
            if (isConnecting) {
                const endNode = e.target.closest('.node');

                // Remove a linha temporária em todos os casos
                if (tempLine) {
                    tempLine.remove();
                    tempLine = null;
                }

                // Verifica se a conexão é válida
                if (endNode && startNode && endNode.id !== startNode.id) {
                    // Verifica se já não existe uma conexão
                    const exists = connections.some(c =>
                        (c.from === startNode.id && c.to === endNode.id) ||
                        (c.from === endNode.id && c.to === startNode.id)
                    );

                    if (!exists) {
                        createConnection(startNode, endNode);
                    } else {
                        alert('A conexão entre estas tarefas já existe.');
                    }
                }

                // Reseta o estado de conexão
                isConnecting = false;
                startNode = null;
            }
        });
        // ----- FIM DA LÓGICA DE CONEXÃO REFEITA -----

        // Adicionar tarefa
        addTaskBtn.addEventListener('click', function() {
            const name = taskNameInput.value.trim();
            const time = taskTimeInput.value;

            if (!name || !time) {
                alert('Por favor, preencha o nome e o horário da tarefa.');
                return;
            }
            
            let repeatDays = [];
            const selectedOption = document.querySelector('input[name="repeatOption"]:checked').value;
            
            if (selectedOption !== 'none') {
                const checkedDays = Array.from(document.querySelectorAll('#daySelection .day-checkbox:checked')).map(cb => cb.value);
                if (checkedDays.length === 0) {
                     alert('Por favor, selecione pelo menos um dia.');
                     return;
                }
                if (selectedOption === 'specific') {
                    repeatDays = checkedDays;
                } else if (selectedOption === 'except') {
                     const allDays = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                     repeatDays = allDays.filter(day => !checkedDays.includes(day));
                }
            }

            addTask(name, time, repeatDays);
            taskNameInput.value = '';
            taskTimeInput.value = '';
            document.getElementById('noRepeat').checked = true;
            daySelection.classList.add('hidden');
            dayCheckboxes.forEach(cb => cb.checked = false);
        });

        // Limpar tudo
        clearAllBtn.addEventListener('click', () => {
            if (confirm('Tem certeza que deseja limpar todas as tarefas e conexões?')) {
                clearAllTasks();
            }
        });

        // Mostrar/ocultar seleção de dias
        repeatOptions.forEach(option => {
            option.addEventListener('change', function() {
                daySelection.classList.toggle('hidden', this.value === 'none');
            });
        });

        function addTask(name, time, repeatDays = []) {
            const taskId = 'task-' + Date.now();
            const repeatText = repeatDays.length > 0 ?
                `Repete: ${repeatDays.map(d => d.substring(0,3)).join(', ')}` :
                'Não repete';

            const node = document.createElement('div');
            node.className = 'node absolute w-40 h-40 bg-white rounded-full flex flex-col items-center justify-center cursor-move z-20 p-2';
            node.id = taskId;
            
            const containerRect = mindmap.getBoundingClientRect();
            const x = Math.random() * (containerRect.width - 160) + 40;
            const y = Math.random() * (containerRect.height - 160) + 40;
            node.style.left = `${x}px`;
            node.style.top = `${y}px`;

            node.innerHTML = `
                <div class="task-time text-blue-600 text-lg">${time}</div>
                <div class="text-sm font-semibold text-gray-800 text-center px-1 break-words">${name}</div>
                <div class="text-xs text-gray-500 mt-1">${repeatText}</div>
                <div class="connection-handle" style="top: 0; left: 50%; transform: translate(-50%, -50%);"></div>
                <div class="connection-handle" style="bottom: 0; left: 50%; transform: translate(-50%, 50%);"></div>
                <div class="connection-handle" style="left: 0; top: 50%; transform: translate(-50%, -50%);"></div>
                <div class="connection-handle" style="right: 0; top: 50%; transform: translate(50%, -50%);"></div>
            `;
            mindmap.appendChild(node);
            
            // Adiciona a tarefa ao nosso objeto de estado
            tasks[taskId] = { id: taskId, name, time, node };

            // Torna o nó arrastável
            const draggie = new Draggabilly(node, { containment: mindmap });
            draggies.push(draggie);
            
            // **SOLUÇÃO PARA O PROBLEMA DE ATUALIZAÇÃO DA LINHA**
            // O LeaderLine-new atualiza automaticamente quando o elemento é movido via CSS transform.
            // A chamada manual para 'position()' garante a atualização em todos os casos.
            draggie.on('dragMove', () => {
                connections.forEach(conn => conn.line.position());
            });
        }
        
        function createConnection(fromNode, toNode) {
            const line = new LeaderLine(
                fromNode, toNode, {
                    color: '#3b82f6',
                    size: 2,
                    path: 'fluid',
                    startPlug: 'behind',
                    endPlug: 'arrow1',
                    dash: { animation: false }
                }
            );
            
            line.element.classList.add('line-animation');

            connections.push({
                from: fromNode.id,
                to: toNode.id,
                line: line
            });
            updateConnectionsList();
        }

        function updateConnectionsList() {
            if (connections.length === 0) {
                connectionsList.innerHTML = '<p class="text-gray-400 italic">Nenhuma conexão ainda.</p>';
                return;
            }

            let html = '<div class="space-y-2">';
            connections.forEach((conn, index) => {
                const fromTask = tasks[conn.from];
                const toTask = tasks[conn.to];
                if (!fromTask || !toTask) return; // Segurança

                html += `
                    <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                        <div class="flex items-center">
                            <span class="font-medium">${fromTask.name}</span>
                            <span class="mx-2 text-gray-400">→</span>
                            <span class="font-medium">${toTask.name}</span>
                        </div>
                        <button class="text-red-500 hover:text-red-700 text-sm remove-conn-btn" data-index="${index}">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>`;
            });
            html += '</div>';
            connectionsList.innerHTML = html;
        }

        // Event listener para remover conexões (usando delegação de eventos)
        connectionsList.addEventListener('click', (e) => {
            if (e.target.closest('.remove-conn-btn')) {
                const index = parseInt(e.target.closest('.remove-conn-btn').dataset.index);
                removeConnection(index);
            }
        });

        function removeConnection(index) {
            if (index >= 0 && index < connections.length) {
                connections[index].line.remove();
                connections.splice(index, 1);
                updateConnectionsList();
            }
        }
        
        function clearAllTasks() {
            connections.forEach(conn => conn.line.remove());
            connections = [];

            draggies.forEach(d => d.destroy());
            draggies = [];
            
            mindmap.innerHTML = '';
            tasks = {};

            updateConnectionsList();
        }

        function initializeSampleTasks() {
            addTask('Rotina Matinal', '08:00', ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday']);
            addTask('Reunião de Equipe', '10:30', ['Monday', 'Friday']);
            addTask('Almoço', '12:30');
            addTask('Trabalhar no Projeto', '14:00', ['Tuesday', 'Thursday']);

            setTimeout(() => {
                const taskNodes = document.querySelectorAll('.node');
                if (taskNodes.length >= 2) {
                    createConnection(taskNodes[0], taskNodes[1]);
                }
                if (taskNodes.length >= 3) {
                    createConnection(taskNodes[1], taskNodes[2]);
                }
            }, 200);
        }

        initializeSampleTasks();
    });
    </script>
</body>
</html>
